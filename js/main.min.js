"use strict";const optionSlider={sliderPerView:1,loop:!0,autoplay:!0,effect:"coverflow"},swiper=new Swiper(".swiper-container",optionSlider),RED_COLOR="#ff0000",cartButton=document.querySelector("#cart-button"),modal=document.querySelector(".modal"),close=document.querySelector(".close"),buttonAuth=document.querySelector(".button-auth"),closeAuth=document.querySelector(".close-auth"),modalAuth=document.querySelector(".modal-auth"),logInForm=document.querySelector("#logInForm"),loginInput=document.querySelector("#login"),passwordInput=document.querySelector("#password"),userName=document.querySelector(".user-name"),buttonOut=document.querySelector(".button-out"),cardsRestaurants=document.querySelector(".cards-restaurants"),containerPromo=document.querySelector(".container-promo"),restaurants=document.querySelector(".restaurants"),menu=document.querySelector(".menu"),logo=document.querySelector(".logo"),cardsMenu=document.querySelector(".cards-menu"),restaurantTitle=document.querySelector(".restaurant-title"),restaurantRating=document.querySelector(".rating"),restaurantPrice=document.querySelector(".price"),restaurantCategory=document.querySelector(".category"),inputAddress=document.querySelector(".input-address"),inputSearch=document.querySelector(".input-search"),modalBody=document.querySelector(".modal-body"),modalPrice=document.querySelector(".modal-pricetag"),buttonClearCart=document.querySelector(".clear-cart");let login=localStorage.getItem("gloDelivery");const cart=JSON.parse(localStorage.getItem("gloDelivery_"+login))||[];function saveCart(){localStorage.setItem("gloDelivery_"+login,JSON.stringify(cart))}function downloadCart(){if(localStorage.getItem("gloDelivery_"+login)){const t=JSON.parse(localStorage.getItem("gloDelivery_"+login));cart.push(...t)}}const getData=async function(t){const e=await fetch(t);if(!e.ok)throw new Error(`Ошибка по адресу ${t}, статус: ${e.status}`);return e.json()},validName=function(t){return/^[a-zA-Z][a-zA-Z0-9-_\.]{3,20}$/.test(t)},toggleModal=function(){modal.classList.toggle("is-open")},toggleModalAuth=function(){modalAuth.classList.toggle("is-open"),modalAuth.classList.contains("is-open")?disableScroll():enableScroll()},clearForm=function(){loginInput.style.borderColor="",logInForm.reset()};function returnMain(){containerPromo.classList.remove("hide"),swiper.init(optionSlider),restaurants.classList.remove("hide"),menu.classList.add("hide")}function authorized(){userName.textContent=login,buttonAuth.style.display="none",userName.style.display="inline",buttonOut.style.display="block",cartButton.style.display="flex",buttonOut.addEventListener("click",(function t(){login=null,cart.length=0,localStorage.removeItem("gloDelivery"),buttonAuth.style.display="",userName.style.display="",buttonOut.style.display="",cartButton.style.display="",buttonOut.removeEventListener("click",t),checkAuth(),returnMain()}))}function notAuthorized(){buttonAuth.addEventListener("click",toggleModalAuth),closeAuth.addEventListener("click",toggleModalAuth),logInForm.addEventListener("submit",(function t(e){var n;e.preventDefault(),n=loginInput.value,/^[a-zA-Z][a-zA-Z0-9-_\.]{3,20}$/.test(n)?(login=loginInput.value,localStorage.setItem("gloDelivery",login),toggleModalAuth(),downloadCart(),buttonAuth.removeEventListener("click",toggleModalAuth),closeAuth.removeEventListener("click",toggleModalAuth),logInForm.removeEventListener("submit",t),logInForm.reset(),checkAuth()):(loginInput.style.borderColor="#ff0000",loginInput.value="")})),modalAuth.addEventListener("click",(function(t){t.target.classList.contains("is-open")&&toggleModalAuth()}))}function checkAuth(){login?authorized():notAuthorized()}function createCardRestaurant({image:t,kitchen:e,name:n,price:o,stars:r,products:a,time_of_delivery:c}){const s=document.createElement("a");s.classList.add("card","card-restaurant"),s.products=a,s.info={kitchen:e,name:n,price:o,stars:r};const i=`\n    <img src=${t} alt=${n} class="card-image"/>\n    <div class="card-text">\n      <div class="card-heading">\n        <h3 class="card-title">${n}</h3>\n        <span class="card-tag tag">${c} мин</span>\n      </div>\n      <div class="card-info">\n        <div class="rating">\n          ${r}\n        </div>\n        <div class="price">От ${o} ₽</div>\n        <div class="category">${e}</div>\n      </div>\n    </div>\n  `;s.insertAdjacentHTML("beforeend",i),cardsRestaurants.insertAdjacentElement("beforeend",s)}function createCardGood({description:t,id:e,image:n,name:o,price:r}){const a=document.createElement("div");a.className="card",a.id=e,a.insertAdjacentHTML("beforeend",`\n    <img src=${n} alt=${o} class="card-image"/>\n    <div class="card-text">\n      <div class="card-heading">\n        <h3 class="card-title card-title-reg">${o}</h3>\n      </div>\n      <div class="card-info">\n        <p class="ingredients">${t}</p>\n      </div>\n      <div class="card-buttons">\n        <button class="button button-primary button-add-cart">\n          <span class="button-card-text">В корзину</span>\n          <span class="button-cart-svg"></span>\n        </button>\n        <strong class="card-price card-price-bold">${r} ₽</strong>\n      </div>\n    </div>\n  `),cardsMenu.insertAdjacentElement("beforeend",a)}function openGoods(t){const e=t.target;if(login){const t=e.closest(".card-restaurant");if(t){cardsMenu.textContent="",containerPromo.classList.add("hide"),swiper.destroy(!1),restaurants.classList.add("hide"),menu.classList.remove("hide");const{name:e,kitchen:n,price:o,stars:r}=t.info;restaurantTitle.textContent=e,restaurantRating.textContent=r,restaurantPrice.textContent=`От ${o} ₽`,restaurantCategory.textContent=n,getData("./db/"+t.products).then((function(t){t.forEach(createCardGood)}))}}else toggleModalAuth()}function addToCart(t){const e=t.target;if(e.closest(".button-add-cart")){const t=e.closest(".card"),n=t.querySelector(".card-title-reg").textContent,o=t.querySelector(".card-price").textContent,r=t.id,a=cart.find((function(t){return t.id===r}));a?a.count++:cart.push({title:n,cost:o,id:r,count:1}),saveCart()}}function renderCart(){modalBody.textContent="",cart.forEach((function({title:t,cost:e,id:n,count:o}){const r=`\n      <div class="food-row">\n        <span class="food-name">${t}</span>\n        <strong class="food-price">${e} ₽</strong>\n        <div class="food-counter">\n          <button class="counter-button counter-minus" data-id=${n}>-</button>\n          <span class="counter">${o}</span>\n          <button class="counter-button counter-plus" data-id=${n}>+</button>\n        </div>\n      </div>\n    `;modalBody.insertAdjacentHTML("afterbegin",r)}));const t=cart.reduce((function(t,e){return t+parseFloat(e.cost)*e.count}),0);modalPrice.textContent=t+" ₽",saveCart()}function changeCount(t){const e=t.target;if(e.classList.contains("counter-button")){const t=cart.find((function(t){return t.id===e.dataset.id}));e.classList.contains("counter-minus")&&(t.count--,t.count||cart.splice(cart.indexOf(t),1)),e.classList.contains("counter-plus")&&t.count++,renderCart()}}function searchHandler(t){const e=t.target.value.trim();if(!e&&13===t.charCode)return t.target.style.backgroundColor="#ff0000",t.target.value="",void setTimeout((function(){t.target.style.backgroundColor=""}),1500);/^[А-Яа-яЁё]$/.test(t.key)?e.length<3||getData("./db/partners.json").then((function(t){return t.map((function(t){return t.products}))})).then((function(t){cardsMenu.textContent="",t.forEach((function(t){getData("./db/"+t).then((function(t){const n=t.filter((function(t){return t.name.toLowerCase().includes(e.toLowerCase())}));containerPromo.classList.add("hide"),swiper.destroy(!1),restaurants.classList.add("hide"),menu.classList.remove("hide"),restaurantTitle.textContent="Результат поиска",restaurantRating.textContent="",restaurantPrice.textContent="",restaurantCategory.textContent="разная кухня",n.forEach(createCardGood)}))}))})):console.log(t.key)}function init(){getData("./db/partners.json").then((function(t){t.forEach(createCardRestaurant)})),buttonAuth.addEventListener("click",clearForm),cardsMenu.addEventListener("click",addToCart),cardsRestaurants.addEventListener("click",openGoods),modalBody.addEventListener("click",changeCount),close.addEventListener("click",toggleModal),cartButton.addEventListener("click",(function(){renderCart(),toggleModal()})),buttonClearCart.addEventListener("click",(function(){cart.length=0,renderCart(),toggleModal()})),logo.addEventListener("click",(function(){containerPromo.classList.remove("hide"),swiper.init(optionSlider),restaurants.classList.remove("hide"),menu.classList.add("hide")})),inputSearch.addEventListener("keyup",searchHandler),inputAddress.addEventListener("keyup",searchHandler),checkAuth()}init();